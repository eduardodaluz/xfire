<project default="multiproject:install" xmlns:c="jelly:core" xmlns:maven="jelly:maven" xmlns:ant="jelly:ant" xmlns:util="jelly:util">

	<postGoal name="build:start">
		<c:set var="maven.multiproject.includes" value="${maven.multiproject.includes},${maven.multiproject.excludes}"/>
		<c:set var="maven.multiproject.excludes" value=""/>

		<!-- In order to process dependencies -->
		<maven:reactor goals="build:start" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>
		<!-- Collect data -->
		<maven:reactor collectionVar="modules" collectOnly="true" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>
		
		<!-- Prepares -->
		<ant:mkdir dir="${pom.build.sourceDirectory}"/>
		<ant:mkdir dir="${pom.build.unitTestSourceDirectory}"/>
		
		<c:forEach items="${modules}" var="module" indexVar="i">
			<!-- Adds source folders -->
			<ant:copy toDir="${pom.build.sourceDirectory}">
				<fileset dir="${module.build.sourceDirectory}" includes="**/*" excludes="**/.*,**/CVS"/>
			</ant:copy>

			<!-- Adds tests source folders -->
			<ant:copy toDir="${pom.build.unitTestSourceDirectory}">
				<fileset dir="${module.build.unitTestSourceDirectory}" includes="**/*" excludes="**/.*,**/CVS"/>
			</ant:copy>

			<!-- Adds dependencies -->
			<c:forEach items="${module.artifacts}" var="dependency" indexVar="j">
				<c:if test="${dependency.groupId != 'xfire'}">
					<ant:path id="xfire.all.dependency.${i}.${j}" location="${dependency.path}"/>
					<maven:addPath id="maven.dependency.classpath" refid="xfire.all.dependency.${i}.${j}"/>
				</c:if>
			</c:forEach>
		</c:forEach>
		<c:set var="sourcesPresent" value="true"/>
		<c:set var="unitTestSourcesPresent" value="false"/>
	</postGoal>
	
	<postGoal name="clean:clean">
		<attainGoal name="build:start"/>
	</postGoal>

	<goal name="eclipse:generate-project">
		<ant:echo>Its just a meta project. No Eclipse project for you.</ant:echo>
	</goal>
	<goal name="eclipse:generate-classpath">
		<ant:echo>Its just a meta project. No Eclipse project for you.</ant:echo>
	</goal>
	
	<goal name="java:compile">
		<!-- Compile -->
		<maven:reactor goals="java:compile" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>

		<!-- Collect data -->
		<maven:reactor collectionVar="modules" collectOnly="true" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>

		<!-- Copies the classes -->
		<ant:mkdir dir="${maven.build.dest}"/>
		<c:forEach items="${modules}" var="module" indexVar="i">
			<ant:copy toDir="${maven.build.dest}">
				<fileset dir="${basedir}/../${module.artifactId}/target/classes" includes="**/*" excludes="**/.*,**/CVS"/>
			</ant:copy>
			<maven:copy-resources resources="${module.build.resources}" todir="${maven.build.dest}"/>
		</c:forEach>
	</goal>
	
	<goal name="test:compile" prereqs="java:compile">
		<!-- Compile -->
		<maven:reactor goals="test:compile" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>

		<!-- Collect data -->
		<maven:reactor collectionVar="modules" collectOnly="true" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>

		<!-- Copies the classes -->
		<ant:mkdir dir="${maven.test.dest}"/>
		<c:forEach items="${modules}" var="module" indexVar="i">
			<ant:copy toDir="${maven.test.dest}">
				<fileset dir="${basedir}/../${module.artifactId}/target/test-classes" includes="**/*" excludes="**/.*,**/CVS"/>
			</ant:copy>
			<maven:copy-resources resources="${module.build.unitTest.resources}" todir="${maven.test.dest}"/>
		</c:forEach>
	</goal>

	<goal name="dist:prepare-examples">
		<mkdir dir="${maven.build.dir}/dist/examples"/>

		<ant:copy toDir="${maven.build.dir}/dist/examples">
			<fileset dir="${basedir}/../examples" includes="**/*" excludes="${basedir}/../examples/geoip-client,**/.*,**/CVS"/>
			<filterset>
			  <filter token="xfire.version" value="${pom.currentVersion}"/>
		  </filterset>
		</ant:copy>
  </goal>
		
	<goal name="dist:prepare">
		<mkdir dir="${maven.build.dir}/dist/modules"/>
		<mkdir dir="${maven.build.dir}/dist/libs"/>
		<mkdir dir="${maven.build.dir}/dist/manual"/>
		
		<ant:get src="http://docs.codehaus.org/spaces/doexportspace.action?key=XFIRE&amp;type=TYPE_HTML&amp;os_username=xexporter&amp;os_password=xfire" dest="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}-manual.zip"/>
		<ant:unzip src="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}-manual.zip" dest="${maven.build.dir}/manual"/>
		<ant:copy toDir="${maven.build.dir}/dist/manual">
			<fileset dir="${maven.build.dir}/manual/XFIRE" includes="**/*" excludes="**/.*,**/CVS"/>
		</ant:copy>
		
		<attainGoal name="dist:prepare-examples"/>
		
		<!-- Make jars -->
		<maven:reactor goals="jar:jar" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml"/>
		
		<!-- Collect data -->
		<maven:reactor collectionVar="modules" collectOnly="true" basedir="${basedir}/.." includes="${maven.multiproject.includes}" excludes="${maven.multiproject.excludes},xfire-all/project.xml,xfire-plexus/project.xml,xfire-picocontainer/project.xml,xfire-loom/project.xml"/>
		<c:forEach items="${modules}" var="module">
			<copy toDir="${maven.build.dir}/dist/modules" 
				file="${basedir}/../${module.artifactId}/target/${module.artifactId}-${module.currentVersion}.jar"/>
			<c:forEach items="${module.artifacts}" var="dependency">
				<c:if test="${!dependency.dependency.artifactId.startsWith('xfire')}">
					<c:set var="scope" value="${dependency.dependency.getProperty('scope')} "/>
					<c:if test="${scope == ' '}">
						<copy toDir="${maven.build.dir}/dist/libs/" file="${dependency.path}"/>
					</c:if>
				</c:if>
			</c:forEach>
			<copy tofile="${maven.build.dir}/dist/libs/README.txt" file="${basedir}/libs-README.txt"/>
			<copy tofile="${maven.build.dir}/NOTICE.txt" file="${basedir}/NOTICE.txt"/>
			<copy toDir="${maven.build.dir}/dist/libs/">
              <fileset dir="${basedir}/licenses" includes="**/*"/>
		    </copy>
		</c:forEach>
	</goal>

</project>