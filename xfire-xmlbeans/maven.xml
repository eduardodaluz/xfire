<project
  default="jar:install"
  xmlns:j="jelly:core"
  xmlns:ant="jelly:ant"
  xmlns:maven="jelly:maven"  
  xmlns:i="jelly:interaction">

  <ant:path id="xmlbeans.path">
    <ant:path refid="maven.dependency.classpath"/>
    <ant:pathelement path="${maven.build.dest}"/>
    <ant:pathelement path="${maven.test.dest}"/>
  </ant:path>
  
  <!-- Generate Types to process WSDL -->
  <goal name="generate-main">
    <ant:delete dir="${maven.build.dir}/xfire-xmlbeans-main"/>
    <ant:mkdir dir="${maven.build.dir}/xfire-xmlbeans-main"/>

    <!-- Output WSDL types to xfire-xmlbeans-main -->
    <java classname="org.apache.xmlbeans.impl.tool.SchemaCompiler"
          classpathref="xmlbeans.path"
          fork="true">
      <arg value="-srconly"/>
      <arg value="-d"/>
      <arg value="${maven.build.dir}/xfire-xmlbeans-main"/>
      <arg value="${basedir}/src/schemas"/>
    </java>
    
    <ant:copy todir="${maven.build.dest}">
      <ant:fileset dir="${maven.build.dir}/xfire-xmlbeans-main">
        <ant:include name="**/*.xsb"/>
        <ant:include name="**/*.class"/>
      </ant:fileset>
    </ant:copy>
    
    <ant:path id="xfire.xmlbeans.generated.main" 
              location="${maven.build.dir}/xfire-xmlbeans-main"/>

    <maven:addPath id="maven.compile.src.set"  
                   refid="xfire.xmlbeans.generated.main"/>
  </goal>
  
  <!-- 
    Generate XMLBeans objects for all the schemas in src/test-schemas 
    and make the WeatherService
   --> 
  <goal name="generate-test">
    
    <ant:delete dir="${maven.build.dir}/xfire-xmlbeans-test"/>
    <ant:mkdir dir="${maven.build.dir}/xfire-xmlbeans-test"/>
  
    <java classname="org.apache.xmlbeans.impl.tool.SchemaCompiler"
          classpathref="xmlbeans.path"
          fork="true">
      <arg value="-d"/>
      <arg value="${maven.test.dest}"/>
      <arg value="${basedir}/src/test-schemas/WeatherForecast.wsdl"/>
      <arg value="${basedir}/src/test-schemas/anyschema.xsd"/>
    </java>
    
    <ant:path id="generate.path">
      <ant:pathelement path="${maven.build.dest}"/>
      <ant:pathelement path="${maven.build.dir}/xfire-xmlbeans-main"/>
      <ant:path refid="maven.dependency.classpath"/>
      <ant:pathelement path="${maven.test.dest}"/>
    </ant:path>   

    <ant:taskdef name="generate" 
                 classname="org.codehaus.xfire.xmlbeans.generator.GeneratorTask"
                 classpathref="generate.path"/>
    <!-- 
         Generate the Weather Service stub and add the directory to 
         the src set to be compiled. 
     -->
    <!-- echo>Creating Weather Service</echo>
    <generate overwrite="true"
              package="org.codehaus.xfire.xmlbeans.weather"
              outputDir="${maven.build.dir}/xfire-xmlbeans-test"
              wsdl="${basedir}/src/test-schemas/WeatherForecast.wsdl"
              classpathref="generate.path" />   

    <ant:path id="xfire.xmlbeans.generated.test" 
              location="${maven.build.dir}/xfire-xmlbeans-test"/>

    <maven:addPath id="maven.test.compile.src.set"  
                   refid="xfire.xmlbeans.generated.test"/ -->
  </goal>
  
  <goal name="support-jars">
	<mkdir dir="${basedir}/target"/>
    <java classname="org.apache.xmlbeans.impl.tool.SchemaCompiler"
          classpathref="xmlbeans.path"
          fork="true">
      <arg value="-out"/>
      <arg value="${basedir}/target/wsdl.jar"/>
      <arg value="${basedir}/src/schemas"/>
    </java>

    <java classname="org.apache.xmlbeans.impl.tool.SchemaCompiler"
          classpathref="xmlbeans.path"
          fork="true">
      <arg value="-out"/>
      <arg value="${basedir}/target/weather.jar"/>
      <arg value="${basedir}/src/test-schemas/WeatherForecast.wsdl"/>
    </java>

    <java classname="org.apache.xmlbeans.impl.tool.SchemaCompiler"
          classpathref="xmlbeans.path"
          fork="true">
      <arg value="-out"/>
      <arg value="${basedir}/target/anyschema.jar"/>
      <arg value="${basedir}/src/test-schemas/anyschema.xsd"/>
    </java>
  </goal>
  
  <preGoal name="java:compile">
    <attainGoal name="generate-main"/>
  </preGoal>
    
  <preGoal name="test:compile">
    <attainGoal name="generate-test"/>
  </preGoal>
  
</project>